---
- name: User - Ensure sudo group is present
  group:
    name: sudo
    state: present
  tags: user

- name: User - Add the user {{ target_user }}
  ansible.builtin.user:
    name: "{{ target_user }}"
    password: "{{ target_user | password_hash('sha512') }}"
    groups: sudo
    shell: /bin/bash
    update_password: always
    home: "/home/{{ target_user }}"
  tags: user
  become: true

- name: User - Create SSH directory 
  file:
    path: "/home/{{ target_user }}/.ssh"
    state: directory
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: 0700
  tags: user

- name: User - Generate SSH key 
  user:
    name: "{{ target_user }}"
    generate_ssh_key: yes
    ssh_key_type: rsa
    ssh_key_bits: 4096
    ssh_key_file: "/home/{{ target_user }}/.ssh/id_rsa"  
  tags: user

# - name: Check that the /etc/wsl.conf exists
#   stat:
#     path: /etc/wsl.conf
#   register: wslconf_exists

# - name: enable systemd, if wsl.conf exists
#   ansible.builtin.blockinfile:
#     path: /etc/wsl.conf
#     block:  |
#       [boot]
#       systemd=true
#       [user]
#       default={{ target_user }}
#     marker: "## {mark} ANSIBLE MANAGED BLOCK"
#     create: true

- name: User - Check if /etc/sudoers has the user already
  ansible.builtin.lineinfile:
    state: absent
    path: /etc/sudoers
    regexp: "^{{ target_user }}"
  check_mode: true
  changed_when: false 
  register: check
  tags: user
  become: true

- name: User - Print if sudoers has user
  ansible.builtin.debug:
    msg: lineinefile found /etc/sudoers has {{ target_user }}
  when: check.found
  tags: user
  become: true

- name: User - Print if sudoers does not have user
  ansible.builtin.debug:
    msg: lineinefile did not find /etc/sudoers has {{ target_user }}
  when: not check.found
  tags: user
  become: true

- name: User - update sudoers file for user
  ansible.builtin.lineinfile:
    path: /etc/sudoers
    line: '{{ target_user }} ALL=(ALL) NOPASSWD: ALL'
  when: not check.found
  tags: user
