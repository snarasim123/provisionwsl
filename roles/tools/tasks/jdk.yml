# SDKMAN and JDK installation tasks
# Installs SDKMAN, Java 11, 17, 21 and sets Java 11 as default
# To enable: add jdk.yml to tools/tasks/main.yml
---

- name: Install dependencies for SDKMAN
  package:
    name:
      - curl
      - unzip
      - zip
    state: present
  become: true
  tags:
    - jdk
    - java
    - sdkman

- name: Check if SDKMAN is already installed
  stat:
    path: "{{ user_home }}/.sdkman/bin/sdkman-init.sh"
  register: sdkman_installed
  tags:
    - jdk
    - java
    - sdkman

- name: Download and install SDKMAN
  shell: |
    curl -s "https://get.sdkman.io" | bash
  args:
    creates: "{{ user_home }}/.sdkman/bin/sdkman-init.sh"
  become: false
  become_user: "{{ target_user }}"
  when: not sdkman_installed.stat.exists
  tags:
    - jdk
    - java
    - sdkman

- name: Install Java 11 via SDKMAN
  shell: |
    source {{ user_home }}/.sdkman/bin/sdkman-init.sh
    sdk install java 11.0.21-tem || true
  args:
    executable: /bin/bash
  become: false
  become_user: "{{ target_user }}"
  register: java11_install
  changed_when: "'Done installing' in java11_install.stdout"
  tags:
    - jdk
    - java
    - sdkman

- name: Install Java 17 via SDKMAN
  shell: |
    source {{ user_home }}/.sdkman/bin/sdkman-init.sh
    sdk install java 17.0.9-tem || true
  args:
    executable: /bin/bash
  become: false
  become_user: "{{ target_user }}"
  register: java17_install
  changed_when: "'Done installing' in java17_install.stdout"
  tags:
    - jdk
    - java
    - sdkman

- name: Install Java 21 via SDKMAN
  shell: |
    source {{ user_home }}/.sdkman/bin/sdkman-init.sh
    sdk install java 21.0.1-tem || true
  args:
    executable: /bin/bash
  become: false
  become_user: "{{ target_user }}"
  register: java21_install
  changed_when: "'Done installing' in java21_install.stdout"
  tags:
    - jdk
    - java
    - sdkman

- name: Set Java 11 as default
  shell: |
    source {{ user_home }}/.sdkman/bin/sdkman-init.sh
    sdk default java 11.0.21-tem
  args:
    executable: /bin/bash
  become: false
  become_user: "{{ target_user }}"
  tags:
    - jdk
    - java
    - sdkman

- name: Verify Java installation
  shell: |
    source {{ user_home }}/.sdkman/bin/sdkman-init.sh
    java -version 2>&1
  args:
    executable: /bin/bash
  become: false
  become_user: "{{ target_user }}"
  register: java_version
  changed_when: false
  tags:
    - jdk
    - java
    - sdkman

- name: Display installed Java version
  debug:
    msg: "{{ java_version.stdout_lines }}"
  tags:
    - jdk
    - java
    - sdkman

- name: List all installed Java versions
  shell: |
    source {{ user_home }}/.sdkman/bin/sdkman-init.sh
    sdk list java | grep installed || echo "No Java versions installed"
  args:
    executable: /bin/bash
  become: false
  become_user: "{{ target_user }}"
  register: java_list
  changed_when: false
  tags:
    - jdk
    - java
    - sdkman

- name: Display installed Java versions
  debug:
    msg: "{{ java_list.stdout_lines }}"
  tags:
    - jdk
    - java
    - sdkman