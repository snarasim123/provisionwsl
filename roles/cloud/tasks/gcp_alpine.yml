---
# Google Cloud CLI installation for Alpine Linux
# Alpine doesn't have an official gcloud package, so we use the tarball method
# https://cloud.google.com/sdk/docs/install-sdk#linux

- name: Get Python version
  ansible.builtin.command: python3 --version
  register: python_version_output
  changed_when: false
  failed_when: false
  tags:
    - gcp
    - cloud

- name: Extract Python version number
  ansible.builtin.set_fact:
    python_version: "{{ python_version_output.stdout | regex_search('Python ([0-9]+\\.[0-9]+)', '\\1') | first | default('0.0') }}"
  when: python_version_output.rc == 0
  tags:
    - gcp
    - cloud

- name: Set Python version to 0.0 if not found
  ansible.builtin.set_fact:
    python_version: "0.0"
  when: python_version_output.rc != 0
  tags:
    - gcp
    - cloud

- name: Display detected Python version
  ansible.builtin.debug:
    msg: "Detected Python version: {{ python_version }}"
  tags:
    - gcp
    - cloud

- name: Confirm Python version is supported for Google Cloud CLI
  ansible.builtin.assert:
    that:
      - python_version is version(gcp_cli_python_min_version, '>=')
      - python_version is version(gcp_cli_python_max_version, '<=')
    fail_msg: >
      Google Cloud CLI requires Python {{ gcp_cli_python_min_version }} to {{ gcp_cli_python_max_version }}.
      Detected Python version: {{ python_version }}.
      Note: The x86_64 Linux package includes a bundled Python interpreter that will be preferred by default.
    success_msg: "Python version {{ python_version }} is supported for Google Cloud CLI."
  tags:
    - gcp
    - cloud

- name: Install required dependencies for Google Cloud CLI on Alpine
  community.general.apk:
    name:
      - bash
      - curl
      - python3
      - libc6-compat
    state: present
  become: true
  tags:
    - gcp
    - cloud

- name: Check if Google Cloud CLI tar file exists
  ansible.builtin.stat:
    path: "/home/{{ target_user }}/tmp/{{ gcp_cli_archive_name_x86_64 }}"
  register: gcp_cli_tar_file
  tags:
    - gcp
    - cloud

- name: Remove existing Google Cloud CLI tar file if present
  ansible.builtin.file:
    path: "/home/{{ target_user }}/tmp/{{ gcp_cli_archive_name_x86_64 }}"
    state: absent
  when: gcp_cli_tar_file.stat.exists
  tags:
    - gcp
    - cloud

- name: Download Google Cloud CLI tar file
  ansible.builtin.get_url:
    url: https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/{{ gcp_cli_archive_name_x86_64 }}
    dest: "/home/{{ target_user }}/tmp/{{ gcp_cli_archive_name_x86_64 }}"
    mode: '0644'
  tags:
    - gcp
    - cloud

- name: Extract Google Cloud CLI tar file to /usr/local
  ansible.builtin.unarchive:
    src: "/home/{{ target_user }}/tmp/{{ gcp_cli_archive_name_x86_64 }}"
    dest: "/usr/local"
    remote_src: true
  become: true
  tags:
    - gcp
    - cloud

- name: Ensure install.sh has executable permissions
  ansible.builtin.file:
    path: "/usr/local/google-cloud-sdk/install.sh"
    mode: '0755'
  become: true
  tags:
    - gcp
    - cloud

- name: Run Google Cloud CLI install script
  ansible.builtin.shell:
    cmd: /usr/local/google-cloud-sdk/install.sh --quiet --path-update true --command-completion true 2>&1
  register: gcp_install_output
  failed_when: false
  become: true
  tags:
    - gcp
    - cloud

- name: Print Google Cloud CLI install script output
  ansible.builtin.debug:
    msg: 
      - "Return code: {{ gcp_install_output.rc }}"
      - "Output: {{ gcp_install_output.stdout_lines | default([]) }}"
  tags:
    - gcp
    - cloud

- name: Verify gcloud install location
  ansible.builtin.command:
    cmd: which gcloud
  environment:
    PATH: "/usr/local/google-cloud-sdk/bin:{{ ansible_env.PATH }}"
  register: gcloud_location
  changed_when: false
  failed_when: false
  tags:
    - gcp
    - cloud

- name: Print gcloud install location
  ansible.builtin.debug:
    msg: "gcloud installed at: {{ gcloud_location.stdout | default('gcloud not found in PATH') }}"
  tags:
    - gcp
    - cloud

- name: Verify gcloud version
  ansible.builtin.command:
    cmd: gcloud --version
  environment:
    PATH: "/usr/local/google-cloud-sdk/bin:{{ ansible_env.PATH }}"
  register: gcloud_version
  changed_when: false
  failed_when: false
  tags:
    - gcp
    - cloud

- name: Print gcloud version
  ansible.builtin.debug:
    msg: "{{ gcloud_version.stdout_lines | default(['gcloud version not available']) }}"
  tags:
    - gcp
    - cloud

- name: Set fact that GCP CLI is installed
  ansible.builtin.set_fact:
    gcp_cli_installed: true
  when: gcloud_version.rc == 0
  tags:
    - gcp
    - cloud

- name: Install gke-gcloud-auth-plugin for GKE authentication (Alpine)
  ansible.builtin.command:
    cmd: /usr/local/google-cloud-sdk/bin/gcloud components install gke-gcloud-auth-plugin --quiet
  environment:
    PATH: "/usr/local/google-cloud-sdk/bin:{{ ansible_env.PATH }}"
  become: true
  when: gcloud_version.rc == 0
  register: gke_plugin_install
  changed_when: "'All components are up to date' not in gke_plugin_install.stderr"
  tags:
    - gcp
    - cloud
    - gke

- name: Remove Google Cloud CLI tar file from tmp folder
  ansible.builtin.file:
    path: "/home/{{ target_user }}/tmp/{{ gcp_cli_archive_name_x86_64 }}"
    state: absent
  tags:
    - gcp
    - cloud