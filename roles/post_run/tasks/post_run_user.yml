---
- name: Add gcloud to PATH in /etc/environment (Alpine)
  ansible.builtin.lineinfile:
    path: /etc/environment
    regexp: '^PATH='
    line: 'PATH="/usr/local/google-cloud-sdk/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"'
    create: yes
  become: true
  when:
    - is_alpine | bool
    - gcp_cli_installed | default(false)
  tags:
    - post_run
    - gcp

- name: Add gcloud to PATH in user's .bashrc_custom (Alpine)
  ansible.builtin.lineinfile:
    path: "/home/{{ target_user }}/.bashrc_custom"
    line: 'export PATH="/usr/local/google-cloud-sdk/bin:$PATH"'
    create: yes
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
  when:
    - is_alpine | bool
    - gcp_cli_installed | default(false)
  tags:
    - post_run
    - gcp

- name: Add GCP installed marker to .bashrc_custom
  ansible.builtin.lineinfile:
    path: "{{ user_home }}/.bashrc_custom"
    line: '# Google Cloud CLI is installed and configured'
    insertafter: EOF
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
  when: gcp_cli_installed | default(false)
  tags:
    - post_run

- name: Add GCP not installed marker to .bashrc_custom
  ansible.builtin.lineinfile:
    path: "{{ user_home }}/.bashrc_custom"
    line: '# Google Cloud CLI is not installed'
    insertafter: EOF
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
  when: not (gcp_cli_installed | default(false))
  tags:
    - post_run

- name: Add pyenv to .bashrc_custom
  blockinfile:
    path: "{{ user_home }}/.bashrc_custom"
    marker: "# {mark} PYENV CONFIGURATION"
    block: |
      export PYENV_ROOT="$HOME/.pyenv"
      [[ -d $PYENV_ROOT/bin ]] && export PATH="$PYENV_ROOT/bin:$PATH"
      eval "$(pyenv init -)"
      eval "$(pyenv virtualenv-init -)"
    create: yes
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
  when: pyenv_installed_flag | default(false)
  tags:
    - post_run
    - pyenv
