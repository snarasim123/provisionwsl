#!/bin/bash

nxvt () {
rxvt -bg white -fg black -sl 5000  -fn -adobe-courier-medium-r-normal-*-*-180-*-*-m-*-iso8859-1&
#-b&h-lucida-medium-r-normal-*-*-180-*-*-p-*-iso8859-1 -adobe-courier-medium-r-normal-*-*-180-*-*-m-*-iso8859-1
}


find_file() {
#find . -exec grep -i "$1" '{}' \; -print
#egrep -H -B 2 -A 2
find . -exec egrep  -H -B 2 -A 2 -i "$1" '{}' \; -print
}


find_file_name() {
find . -exec grep -li "$1" '{}' \; -print
}

find_file_by_type() {
find . -name "$1" -exec grep -i "$2" '{}' \; -print
}

dusort() {
du -mh  -d 1 "$1" | sort -h
}

kcget(){
    if [ -z "$1" ]; then
    kubectl get pods 
else
    echo "Looking for pods matching : $1"
    kubectl get pods | grep -i $1 
fi
}

kcbash(){
#bash into the first pod which matches the passed in param pattern.
#chooses the first container which is not a traefik container.    
PODS=$(kubectl get pods -A)
podname=""
containername=""
found="false"

for POD in $PODS; do
    if ! echo "$POD" | grep -q "$1"; then
        continue  # Skip to the next iteration
    fi

    podname=$POD
    printf "Found pod $podname \n" 
        
    CONTAINERS=$(kubectl get pod "$POD" -o jsonpath="{.spec.containers[*].name}")
    for CONTAINER in $CONTAINERS; do        
        containername=$CONTAINER
        if ! echo "$containername" | grep -q "traefik"; then                        
            found="true"
            break
        fi

        printf "####### skipping container $containername \n"
        continue
    done
    if [ "$found" = "true" ]; then
        break
    fi
done
    if [ "$found" = "true" ]; then
        printf "####### bash into pod '$podname' container '$containername' \n"  
        kubectl exec -it $podname -c $containername -- /bin/bash
    else
        printf "no pod/container found to shell into. \n"
    fi
printf "no pod/container found to shell into. \n"
}

kcshell(){
    kcbash "$1"
}

kclogs(){    
cur_date="$(date +"%m-%d_%H-%M-%S%3N")"
log_file="-$cur_date.txt"
desc_file="-$cur_date-desc.txt"

PODS=$(kubectl get pods -A)
for POD in $PODS; do
    if ! echo "$POD" | grep -q "$1"; then
        continue  # Skip to the next iteration
    fi

    podname=$POD
    printf "Found pod $podname \n"

    pod_log="$POD$log_file"
    desc_log="$POD$desc_file"
    echo " " >  ./$pod_log

    today=`date "+%Y%m%d%H%M%S"`
    printf "\n\n\n\n####### log time $today\n"  >>  ./$pod_log

    INIT_CONTAINERS=$(kubectl get pod "$POD" -o jsonpath="{.spec.initContainers[*].name}")
    CONTAINERS=$(kubectl get pod "$POD" -o jsonpath="{.spec.containers[*].name}")

    for INIT_CONTAINER in $INIT_CONTAINERS; do
        printf "####### $INIT_CONTAINER init container logs\n\n"   >>  ./$pod_log
        kubectl logs "$podname" -c "$INIT_CONTAINER"  >> ./$pod_log&
        printf "\n \n"  >>  ./$pod_log
    done

    for CONTAINER in $CONTAINERS; do
          printf "####### $CONTAINER container logs\n\n"   >>  ./$pod_log
          kubectl logs "$podname" -c "$CONTAINER"  >> ./$pod_log&
          printf "\n \n"  >>  ./$pod_log
    done

done
}

kcdesc(){    
cur_date="$(date +"%m-%d_%H-%M-%S%3N")"
# log_file="-$cur_date.txt"
desc_file="-$cur_date-desc.txt"

PODS=$(kubectl get pods -A)
for POD in $PODS; do
    if ! echo "$POD" | grep -q "$1"; then
        continue  # Skip to the next iteration
    fi

    podname=$POD
    printf "Found pod $podname \n"

    kubectl describe pod "$podname"   > "$desc_file"&

done
}

kccmd(){
    # pod name/partial unique pod name
    # bash command without any param
}