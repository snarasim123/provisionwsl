#!/bin/bash
# github-key-cleanup.sh
# Remove GitHub SSH keys uploaded during WSL provisioning.
#
# Usage:
#   bash github-key-cleanup.sh <distro_name>
#
# Example:
#   bash github-key-cleanup.sh gcp3
#   bash github-key-cleanup.sh alp2
#
# Requires: curl, jq, ansible-vault (for decrypting secrets.yaml)
#
# The script finds and deletes GitHub SSH keys whose titles match
# the pattern: {HOSTNAME}-{user}-{distro_name}
# Two keys are removed per distro: one for root, one for target_user.
# -------------------------------------------------------------------

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
SECRETS_FILE="$SCRIPT_DIR/secrets.yaml"
SECRETS_PASS="$SCRIPT_DIR/secrets.pass"
VARS_FILE="$SCRIPT_DIR/vars/user_environment.yml"
GITHUB_API="https://api.github.com/user/keys"

# --- Argument validation ---
if [ $# -lt 1 ]; then
    echo "Usage: $0 <distro_name>"
    echo "Example: $0 gcp3"
    exit 1
fi

DISTRO_NAME="$1"

# --- Check prerequisites ---
for cmd in curl jq ansible-vault; do
    if ! command -v "$cmd" &>/dev/null; then
        echo "ERROR: '$cmd' is required but not found in PATH."
        exit 1
    fi
done

if [ ! -f "$SECRETS_FILE" ]; then
    echo "ERROR: secrets.yaml not found at $SECRETS_FILE"
    exit 1
fi

if [ ! -f "$SECRETS_PASS" ]; then
    echo "ERROR: secrets.pass not found at $SECRETS_PASS"
    exit 1
fi

if [ ! -f "$VARS_FILE" ]; then
    echo "ERROR: vars/user_environment.yml not found at $VARS_FILE"
    exit 1
fi

# --- Parse target_user and root_user from vars ---
TARGET_USER=$(grep '^target_user:' "$VARS_FILE" | awk '{print $2}' | tr -d '[:space:]')
ROOT_USER=$(grep '^root_user:' "$VARS_FILE" | awk '{print $2}' | tr -d '[:space:]')

if [ -z "$TARGET_USER" ]; then
    echo "ERROR: Could not parse target_user from $VARS_FILE"
    exit 1
fi

ROOT_USER="${ROOT_USER:-root}"

# --- Decrypt secrets.yaml to get GitHub credentials ---
DECRYPTED=$(ansible-vault view "$SECRETS_FILE" --vault-password-file "$SECRETS_PASS" 2>/dev/null)

GITHUB_USER=$(echo "$DECRYPTED" | grep '^githubuser:' | awk '{print $2}' | tr -d '[:space:]')
GITHUB_PASS=$(echo "$DECRYPTED" | grep '^githubpass:' | awk '{print $2}' | tr -d '[:space:]')

if [ -z "$GITHUB_USER" ] || [ -z "$GITHUB_PASS" ]; then
    echo "ERROR: Could not extract githubuser/githubpass from secrets.yaml"
    exit 1
fi

echo "GitHub user: $GITHUB_USER"

# --- Build key title patterns to match ---
HOSTNAME=$(hostname)
USER_KEY_TITLE="${HOSTNAME}-${TARGET_USER}-${DISTRO_NAME}"
ROOT_KEY_TITLE="${HOSTNAME}-${ROOT_USER}-${DISTRO_NAME}"

echo ""
echo "Looking for SSH keys matching:"
echo "  User key:  $USER_KEY_TITLE"
echo "  Root key:  $ROOT_KEY_TITLE"
echo ""

# --- Fetch all SSH keys (paginated) and delete matches ---
delete_key() {
    local key_id="$1"
    local key_title="$2"

    echo "  Deleting key: '$key_title' (id: $key_id) ..."
    HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
        -X DELETE \
        -u "${GITHUB_USER}:${GITHUB_PASS}" \
        -H "Accept: application/vnd.github+json" \
        "${GITHUB_API}/${key_id}")

    if [ "$HTTP_STATUS" -eq 204 ]; then
        echo "  SUCCESS: Key '$key_title' deleted."
    else
        echo "  WARNING: DELETE returned HTTP $HTTP_STATUS for key '$key_title' (id: $key_id)"
    fi
}

DELETED_COUNT=0
PAGE=1
PER_PAGE=100

while true; do
    RESPONSE=$(curl -s \
        -u "${GITHUB_USER}:${GITHUB_PASS}" \
        -H "Accept: application/vnd.github+json" \
        "${GITHUB_API}?per_page=${PER_PAGE}&page=${PAGE}")

    # Check for API error
    if echo "$RESPONSE" | jq -e '.message' &>/dev/null 2>&1; then
        MSG=$(echo "$RESPONSE" | jq -r '.message')
        if [ "$MSG" != "null" ]; then
            echo "ERROR: GitHub API returned: $MSG"
            exit 1
        fi
    fi

    KEY_COUNT=$(echo "$RESPONSE" | jq 'length')

    if [ "$KEY_COUNT" -eq 0 ]; then
        break
    fi

    # Iterate through keys and match by title
    for i in $(seq 0 $((KEY_COUNT - 1))); do
        KEY_ID=$(echo "$RESPONSE" | jq -r ".[$i].id")
        KEY_TITLE=$(echo "$RESPONSE" | jq -r ".[$i].title")

        if [ "$KEY_TITLE" = "$USER_KEY_TITLE" ] || [ "$KEY_TITLE" = "$ROOT_KEY_TITLE" ]; then
            #delete_key "$KEY_ID" "$KEY_TITLE"
            #DELETED_COUNT=$((DELETED_COUNT + 1))
        fi
    done

    # If fewer results than per_page, we've reached the last page
    if [ "$KEY_COUNT" -lt "$PER_PAGE" ]; then
        break
    fi

    PAGE=$((PAGE + 1))
done

echo ""
if [ "$DELETED_COUNT" -gt 0 ]; then
    echo "Done. Removed $DELETED_COUNT SSH key(s) for distro '$DISTRO_NAME'."
else
    echo "No matching SSH keys found for distro '$DISTRO_NAME'."
    echo "Expected titles: '$USER_KEY_TITLE' or '$ROOT_KEY_TITLE'"
fi
