#!/bin/sh
source ~/variables.sh

# Flag to control display detection method: true = new method, false = legacy method
USE_NEW_DISPLAY_DETECTION=true

# Flag to use Wayland instead of X11: true = Wayland, false = X11
USE_WAYLAND=false

# Detect the Linux environment type
# Returns: "wsl", "local_x", "ssh_x", or "headless"
detect_display_env() {
    # Already set (e.g., by SSH X11 forwarding)
    if [ -n "$DISPLAY" ]; then
        echo "ssh_x"
        return
    fi
    
    # WSL detection
    if grep -qi microsoft /proc/version 2>/dev/null; then
        echo "wsl"
        return
    fi
     
    # Local VM with GUI - check if X server is running locally
    if [ -S /tmp/.X11-unix/X0 ]; then
        echo "local_x"
        return
    fi
    
    # Fallback for headless/no display
    echo "headless"
}

# Set DISPLAY and related variables based on detected environment
set_display() {
    local env_type=$(detect_display_env)
    
    case "$env_type" in
        "ssh_x")
            # DISPLAY already set by SSH - do nothing
            ;;
        "wsl")
            export HOST_IP="$(ip route | awk '/^default/{print $3}')"
            export DISPLAY="${HOST_IP}:0.0"
            export LIBGL_ALWAYS_INDIRECT=0
            export PULSE_SERVER="tcp:$HOST_IP"
            ;;
        "local_x")
            export DISPLAY=:0
            ;;
        "headless")
            # No X server - leave DISPLAY unset
            ;;
    esac
}

# Legacy method using resolv.conf nameserver
set_display_old() {
    export DISPLAY="`grep nameserver /etc/resolv.conf | sed 's/nameserver //'`:0.0"
    export LIBGL_ALWAYS_INDIRECT=0
}

# Set Wayland variables and unset X11 DISPLAY
set_wayland() {
    # Unset X11 display variables
    unset DISPLAY
    unset LIBGL_ALWAYS_INDIRECT
    
    # Set Wayland variables
    export WAYLAND_DISPLAY=wayland-0
    export XDG_SESSION_TYPE=wayland
    export GDK_BACKEND=wayland
    export QT_QPA_PLATFORM=wayland
    export MOZ_ENABLE_WAYLAND=1
    
    # Set XDG_RUNTIME_DIR if not set
    if [ -z "$XDG_RUNTIME_DIR" ]; then
        export XDG_RUNTIME_DIR=/run/user/$(id -u)
        if [ ! -d "$XDG_RUNTIME_DIR" ]; then
            export XDG_RUNTIME_DIR=/tmp
        fi
    fi
}

if [[ "$OSTYPE" == "linux-gnu"* ]]; then
        current_env=Linux;
elif [[ "$OSTYPE" == "darwin"* ]]; then
        current_env=Mac;
elif [[ "$OSTYPE" == "msys" ]]; then
        current_env=CYGWIN;
elif [[ "$OSTYPE" == "cygwin" ]]; then
        current_env=CYGWIN;
elif [[ "$OSTYPE" == "linux-musl" ]]; then
        current_env=Linux;
else
        current_env="Unknown"
fi


if [ $current_env == 'Mac' ]  
then
    export LC_CTYPE=en_US.UTF-8
    export TERM=screen-256color
    export USER=$user_name
    export LSCOLORS="exfxcxdxbxegedabagacad"
    alias ls="ls -G"
    alias ll='ls -Galrth'

fi
if [ $current_env == 'Linux' ]  
then    
    export LC_CTYPE=
    export TERM=screen-256color
    export USER=$user_name
    export CODE_FOLDER=$code_folder
    
    # Set display based on flags
    if [ "$USE_WAYLAND" = true ]; then
        set_wayland
    elif [ "$USE_NEW_DISPLAY_DETECTION" = true ]; then
        set_display
    else
        set_display_old
    fi
    
    #export LS_COLORS="di=34;40:ln=35;40:so=32;40:pi=33;40:ex=31;40:bd=34;46:cd=34;43:su=0;41:sg=0;46:tw=0;42:ow=0;43:"
    #export KUBECONFIG=${HOME}/.kube_aws/config
    ##export KUBECONFIG=${HOME}/.kube_gcp/config
    export KUBECONFIG=${HOME}/.kube/config
    bind "set completion-ignore-case on"
    alias ls="ls --color"
    alias ll='ls -alrth --color'    
    eval $(dircolors ~/.dircolors)
fi

if [ $current_env == 'Unknown' ]  
then
    echo  ***env cannot be identified, set as  ${current_env}***
    export LC_CTYPE=
    export TERM=xterm-256color
    export USER=$user_name
fi

if [ $current_env == 'CYGWIN' ]  
then
    echo setting env for  ${current_env}
    export LC_CTYPE=
    export TERM=xterm-256color
    export USER=$user_name
fi

cd ~

#stty erase ^H
stty erase '^?'
export HISTSIZE=10000
export HISTFILESIZE=20000
shopt -s histappend

cd $STARTUP_FOLDER
export PATH=$HOME/bin:$HOME/.local/bin:/usr/local/bin:/usr/local/sbin:/usr/bin:/usr/sbin:/sbin:/bin

# Add Java to PATH if installed
if grep -qi alpine /etc/os-release 2>/dev/null; then
    # Alpine: auto-detect Java path since package names differ
    if [ -d /usr/lib/jvm ]; then
        JAVA_DIR=$(find /usr/lib/jvm -maxdepth 1 -type d -name "java-*" | head -1)
        if [ -n "$JAVA_DIR" ] && [ -d "$JAVA_DIR/bin" ]; then
            export JAVA_HOME="$JAVA_DIR"
            export PATH="$PATH:$JAVA_HOME/bin"
        fi
    fi
else
    # Ubuntu/Fedora: use standard path
    if [ -d /usr/lib/jvm/java-11-openjdk-amd64/bin ]; then
        export JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64
        export PATH="$PATH:$JAVA_HOME/bin"
    fi
fi

# Pyenv initialization
export PYENV_ROOT="$HOME/.pyenv"
if [[ -d "$PYENV_ROOT/bin" ]]; then
    export PATH="$PYENV_ROOT/bin:$PATH"
fi

# :$HOME/.poetry/bin
# export SCREENDIR=/home/snarasim/.screen
# export GOPATH=/home/snarasim/go
# export GOROOT=/usr/local/go
# export JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64/
