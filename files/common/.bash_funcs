#!/bin/bash

nxvt () {
rxvt -bg white -fg black -sl 5000  -fn -adobe-courier-medium-r-normal-*-*-180-*-*-m-*-iso8859-1&
#-b&h-lucida-medium-r-normal-*-*-180-*-*-p-*-iso8859-1 -adobe-courier-medium-r-normal-*-*-180-*-*-m-*-iso8859-1
}


find_file() {
#find . -exec grep -i "$1" '{}' \; -print
#egrep -H -B 2 -A 2
find . -exec egrep  -H -B 2 -A 2 -i "$1" '{}' \; -print
}


find_file_name() {
find . -exec grep -li "$1" '{}' \; -print
}

find_file_by_type() {
find . -name "$1" -exec grep -i "$2" '{}' \; -print
}

dusort() {
du -mh  -d 1 "$1" | sort -h
}

kcget(){
    if [ -z "$1" ]; then
    kubectl get pods 
else
    echo "Looking for pods matching : $1"
    kubectl get pods | grep -i $1 
fi
}

kcbash(){
#bash into the first pod which matches the passed in param pattern.
#chooses the first container which is not a traefik container.    
PODS=$(kubectl get pods -A)
podname=""
containername=""
found="false"

for POD in $PODS; do
    if ! echo "$POD" | grep -q "$1"; then
        continue  # Skip to the next iteration
    fi

    podname=$POD
    printf "Found pod $podname \n" 
        
    CONTAINERS=$(kubectl get pod "$POD" -o jsonpath="{.spec.containers[*].name}")
    for CONTAINER in $CONTAINERS; do        
        containername=$CONTAINER
        if ! echo "$containername" | grep -q "traefik"; then                        
            found="true"
            break
        fi

        printf "####### skipping container $containername \n"
        continue
    done
    if [ "$found" = "true" ]; then
        break
    fi
done
    if [ "$found" = "true" ]; then
        printf "####### bash into pod '$podname' container '$containername' \n"  
        kubectl exec -it $podname -c $containername -- /bin/bash
    else
        printf "no pod/container found to shell into. \n"
    fi
printf "no pod/container found to shell into. \n"
}

kcshell(){
    kcbash "$1"
}

kclogs(){    
cur_date="$(date +"%m-%d_%H-%M-%S%3N")"
log_file="-$cur_date.txt"
desc_file="-$cur_date-desc.txt"

PODS=$(kubectl get pods -A)
for POD in $PODS; do
    if ! echo "$POD" | grep -q "$1"; then
        continue  # Skip to the next iteration
    fi

    podname=$POD
    printf "Found pod $podname \n"

    pod_log="$POD$log_file"
    desc_log="$POD$desc_file"
    echo " " >  ./$pod_log

    today=`date "+%Y%m%d%H%M%S"`
    printf "\n\n\n\n####### log time $today\n"  >>  ./$pod_log

    INIT_CONTAINERS=$(kubectl get pod "$POD" -o jsonpath="{.spec.initContainers[*].name}")
    CONTAINERS=$(kubectl get pod "$POD" -o jsonpath="{.spec.containers[*].name}")

    for INIT_CONTAINER in $INIT_CONTAINERS; do
        printf "####### $INIT_CONTAINER init container logs\n\n"   >>  ./$pod_log
        kubectl logs "$podname" -c "$INIT_CONTAINER"  >> ./$pod_log&
        printf "\n \n"  >>  ./$pod_log
    done

    for CONTAINER in $CONTAINERS; do
          printf "####### $CONTAINER container logs\n\n"   >>  ./$pod_log
          kubectl logs "$podname" -c "$CONTAINER"  >> ./$pod_log&
          printf "\n \n"  >>  ./$pod_log
    done

done
}

kcdesc(){    
cur_date="$(date +"%m-%d_%H-%M-%S%3N")"
# log_file="-$cur_date.txt"
desc_file="-$cur_date-desc.txt"

PODS=$(kubectl get pods -A)
for POD in $PODS; do
    if ! echo "$POD" | grep -q "$1"; then
        continue  # Skip to the next iteration
    fi

    podname=$POD
    printf "Found pod $podname \n"

    kubectl describe pod "$podname"   > "$desc_file"&

done
}

kccmd(){
    # pod name/partial unique pod name
    # bash command without any param
    echo " "
}

kctimedlogs(){    
    if [ -z "$1" ] || [ -z "$2" ]; then
        printf "Usage: kctimedlogs <pod_pattern> <iterations> [sleep_seconds]\n"
        printf "Example: kctimedlogs kernel 5        (write logs from pods matching pattern kernel, 5 times, wait 60 seconds between each)\n"
        printf "Example: kctimedlogs kernel 5 30     (write logs from pods matching pattern kernel, 5 times, wait 30 seconds between each)\n"
        return 1
    fi
    
    pod_pattern="$1"
    total_iterations="$2"
    sleep_time="${3:-60}"
    
    for ((i=1; i<=total_iterations; i++)); do
        printf "========================================\n"
        printf "Collecting logs - iteration $i of $total_iterations\n"
        printf "Time: $(date)\n"
        printf "========================================\n"
        
        kclogs "$pod_pattern"
        
        if [ $i -lt $total_iterations ]; then
            printf "Waiting $sleep_time seconds before next collection...\n"
            sleep $sleep_time
        fi
    done
    
    printf "========================================\n"
    printf "Completed $total_iterations log collections\n"
    printf "========================================\n"
}

kcrestart(){
    # Restarts a deployment matching the given pattern
    # Usage: kcrestart <deployment_pattern>
    # Example: kcrestart kernel
    
    if [ -z "$1" ]; then
        printf "Usage: kcrestart <deployment_pattern>\n"
        printf "Example: kcrestart kernel\n"
        return 1
    fi
    
    pattern="$1"
    matched_deployments=()
    
    DEPLOYMENTS=$(kubectl get deployments -o jsonpath="{.items[*].metadata.name}")
    for DEPLOYMENT in $DEPLOYMENTS; do
        if ! echo "$DEPLOYMENT" | grep -q "$pattern"; then
            continue
        fi
        matched_deployments+=("$DEPLOYMENT")
    done
    
    if [ ${#matched_deployments[@]} -eq 0 ]; then
        printf "No deployment found matching pattern: $pattern\n"
        return 1
    fi
    
    printf "Found the following deployments matching '$pattern':\n"
    printf "========================================\n"
    for dep in "${matched_deployments[@]}"; do
        printf "  - $dep\n"
    done
    printf "========================================\n"
    
    read -p "Do you want to restart these deployments? (y/n): " confirm
    if [ "$confirm" != "y" ] && [ "$confirm" != "Y" ]; then
        printf "Restart cancelled.\n"
        return 0
    fi
    
    for dep in "${matched_deployments[@]}"; do
        printf "Restarting deployment: $dep\n"
        kubectl rollout restart deployment/"$dep"
    done
    
    printf "Restart initiated for ${#matched_deployments[@]} deployment(s).\n"
}
 