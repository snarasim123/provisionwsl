#!/bin/bash

nxvt () {
rxvt -bg white -fg black -sl 5000  -fn -adobe-courier-medium-r-normal-*-*-180-*-*-m-*-iso8859-1&
#-b&h-lucida-medium-r-normal-*-*-180-*-*-p-*-iso8859-1 -adobe-courier-medium-r-normal-*-*-180-*-*-m-*-iso8859-1
}


find_file() {
#find . -exec grep -i "$1" '{}' \; -print
#egrep -H -B 2 -A 2
find . -exec egrep  -H -B 2 -A 2 -i "$1" '{}' \; -print
}


find_file_name() {
find . -exec grep -li "$1" '{}' \; -print
}

find_file_by_type() {
find . -name "$1" -exec grep -i "$2" '{}' \; -print
}

dusort() {
du -mh  -d 1 "$1" | sort -h
}

kcget(){
    if [ -z "$1" ]; then
    kubectl get pods 
else
    echo "Looking for pods matching : $1"
    kubectl get pods -A --no-headers -o custom-columns="NAMESPACE:.metadata.namespace,NAME:.metadata.name" | grep -i $1 
fi
}

kcbash(){
#bash into the first pod which matches the passed in param pattern.
#chooses the first container which is not a traefik container.    

    if [ -z "$1" ]; then
        printf "Usage: kcbash <pod_pattern>\n"
        printf "Example: kcbash kernel\n"
        return 1
    fi

    local podname=""
    local namespace=""
    local containername=""

    # Read line-by-line with proper field parsing; match only against pod name
    while read -r ns name ready status restarts age; do
        if ! echo "$name" | grep -qi "$1"; then
            continue
        fi

        podname="$name"
        namespace="$ns"
        printf "Found pod $podname in namespace $namespace\n"

        CONTAINERS=$(kubectl get pod "$podname" -n "$namespace" -o jsonpath="{.spec.containers[*].name}")
        for CONTAINER in $CONTAINERS; do
            if ! echo "$CONTAINER" | grep -q "traefik"; then
                containername="$CONTAINER"
                break
            fi
            printf "####### skipping container $CONTAINER\n"
        done

        # Found a valid container, stop searching pods
        if [ -n "$containername" ]; then
            break
        fi
    done < <(kubectl get pods -A --no-headers)

    if [ -n "$containername" ]; then
        printf "####### bash into pod '$podname' container '$containername' (namespace: $namespace)\n"
        kubectl exec -it "$podname" -n "$namespace" -c "$containername" -- /bin/bash
    else
        printf "no pod/container found to shell into.\n"
    fi
}

kcshell(){
    if [ -z "$1" ]; then
        printf "Usage: kcshell <pod_pattern>\n"
        printf "Example: kcshell kernel\n"
        printf "Alias for kcbash - shells into the first matching pod's non-traefik container.\n"
        return 1
    fi
    kcbash "$1"
}

kclogs(){    
cur_date="$(date +"%m-%d_%H-%M-%S%3N")"
log_file="-$cur_date.txt"

if [ -z "$1" ]; then
    printf "Usage: kclogs <pod_pattern>\n"
    printf "Example: kclogs kernel\n"
    return 1
fi

overall_start=$SECONDS

search_start=$SECONDS
matching_pods=$(kubectl get pods -A --no-headers | grep -i "$1")
search_elapsed=$(( SECONDS - search_start ))
match_count=$(echo "$matching_pods" | grep -c .)
printf "[timing] pod search took ${search_elapsed}s, found $match_count pod(s)\n"

echo "$matching_pods" | while read -r namespace podname ready status restarts age; do
    [ -z "$podname" ] && continue

    pod_start=$SECONDS
    printf "Found pod $podname in namespace $namespace\n"

    pod_log="$podname$log_file"
    echo " " >  ./$pod_log

    today=$(date "+%Y%m%d%H%M%S")
    printf "\n\n\n\n####### log time $today\n"  >>  ./$pod_log

    INIT_CONTAINERS=$(kubectl get pod "$podname" -n "$namespace" -o jsonpath="{.spec.initContainers[*].name}")
    CONTAINERS=$(kubectl get pod "$podname" -n "$namespace" -o jsonpath="{.spec.containers[*].name}")

    for INIT_CONTAINER in $INIT_CONTAINERS; do
        printf "####### $INIT_CONTAINER init container logs\n\n" | tee -a ./$pod_log
        container_start=$SECONDS
        kubectl logs "$podname" -n "$namespace" -c "$INIT_CONTAINER" >> ./$pod_log
        printf "[timing] init container '$INIT_CONTAINER' logs took $(( SECONDS - container_start ))s\n"
        printf "\n \n" | tee -a ./$pod_log
    done

    for CONTAINER in $CONTAINERS; do
          printf "####### $CONTAINER container logs\n\n" | tee -a ./$pod_log
          container_start=$SECONDS
          kubectl logs "$podname" -n "$namespace" -c "$CONTAINER" >> ./$pod_log
          printf "[timing] container '$CONTAINER' logs took $(( SECONDS - container_start ))s\n"
          printf "\n \n" | tee -a ./$pod_log
    done

    printf "[timing] pod '$podname' total: $(( SECONDS - pod_start ))s, log file: $pod_log\n"

done

printf "[timing] kclogs total: $(( SECONDS - overall_start ))s\n"
}

kcdesc(){    
    if [ -z "$1" ]; then
        printf "Usage: kcdesc <pod_pattern>\n"
        printf "Example: kcdesc kernel\n"
        return 1
    fi

    cur_date="$(date +"%m-%d_%H-%M-%S%3N")"
    desc_file="-$cur_date-desc.txt"

    kubectl get pods -A --no-headers | grep -i "$1" | while read -r namespace podname ready status restarts age; do
        [ -z "$podname" ] && continue
        printf "Found pod $podname in namespace $namespace\n"
        kubectl describe pod "$podname" -n "$namespace" > "$podname$desc_file" &
    done

    wait
    printf "Done. Describe files written with suffix $desc_file\n"
}

kccmd(){
    # pod name/partial unique pod name
    # bash command without any param
    echo " "
}

kctimedlogs(){    
    if [ -z "$1" ] || [ -z "$2" ]; then
        printf "Usage: kctimedlogs <pod_pattern> <iterations> [sleep_seconds]\n"
        printf "Example: kctimedlogs kernel 5        (write logs from pods matching pattern kernel, 5 times, wait 60 seconds between each)\n"
        printf "Example: kctimedlogs kernel 5 30     (write logs from pods matching pattern kernel, 5 times, wait 30 seconds between each)\n"
        return 1
    fi
    
    pod_pattern="$1"
    total_iterations="$2"
    sleep_time="${3:-60}"
    
    for ((i=1; i<=total_iterations; i++)); do
        printf "========================================\n"
        printf "Collecting logs - iteration $i of $total_iterations\n"
        printf "Time: $(date)\n"
        printf "========================================\n"
        
        kclogs "$pod_pattern"
        
        if [ $i -lt $total_iterations ]; then
            printf "Waiting $sleep_time seconds before next collection...Time: $(date)\n"
            sleep $sleep_time
        fi
    done
    
    printf "========================================\n"
    printf "Completed $total_iterations log collections\n"
    printf "========================================\n"
}

kcrestart(){
    # Restarts a deployment matching the given pattern
    # Usage: kcrestart <deployment_pattern>
    # Example: kcrestart kernel
    
    if [ -z "$1" ]; then
        printf "Usage: kcrestart <deployment_pattern>\n"
        printf "Example: kcrestart kernel\n"
        return 1
    fi
    
    pattern="$1"
    matched_deployments=()
    
    DEPLOYMENTS=$(kubectl get deployments -o jsonpath="{.items[*].metadata.name}")
    for DEPLOYMENT in $DEPLOYMENTS; do
        if ! echo "$DEPLOYMENT" | grep -q "$pattern"; then
            continue
        fi
        matched_deployments+=("$DEPLOYMENT")
    done
    
    if [ ${#matched_deployments[@]} -eq 0 ]; then
        printf "No deployment found matching pattern: $pattern\n"
        return 1
    fi
    
    printf "Found the following deployments matching '$pattern':\n"
    printf "========================================\n"
    for dep in "${matched_deployments[@]}"; do
        printf "  - $dep\n"
    done
    printf "========================================\n"
    
    read -p "Do you want to restart these deployments? (y/n): " confirm
    if [ "$confirm" != "y" ] && [ "$confirm" != "Y" ]; then
        printf "Restart cancelled.\n"
        return 0
    fi
    
    for dep in "${matched_deployments[@]}"; do
        printf "Restarting deployment: $dep\n"
        kubectl rollout restart deployment/"$dep"
    done
    
    printf "Restart initiated for ${#matched_deployments[@]} deployment(s).\n"
}
 
pyenvact() {
    eval "$(pyenv init -)"
    eval "$(pyenv virtualenv-init -)"
    echo "pyenv shims activated ($(pyenv version-name))"
}

pyenvdeact() {
    unset PYENV_VERSION
    export PATH=$(echo "$PATH" | tr ':' '\n' | grep -v '.pyenv/shims' | tr '\n' ':' | sed 's/:$//')
    hash -r
    echo "pyenv deactivated (system python: $(python3 --version 2>&1))"
}